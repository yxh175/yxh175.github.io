---
title: Mysql：事务隔离详解
date: 2023-10-25 10:31:36
categories: 
- 八股
tags:
- mysql
---


## 事务是什么？

事务是一种执行模式，其有基础的四大特性ACID

- A （Atomicity）原子性：一个事务中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节，而且事务在执行过程中发生错误，会被回滚到事务开始前的状态，就像这个事务从来没有执行过一样，就好比买一件商品，购买成功时，则给商家付了钱，商品到手；购买失败时，则商品在商家手中，消费者的钱也没花出去。
- C （Consistency）一致性：是指事务操作前和操作后，数据满足完整性约束，数据库保持一致性状态。比如，用户 A 和用户 B 在银行分别有 800 元和 600 元，总共 1400 元，用户 A 给用户 B 转账 200 元，分为两个步骤，从 A 的账户扣除 200 元和对 B 的账户增加 200 元。一致性就是要求上述步骤操作后，最后的结果是用户 A 还有 600 元，用户 B 有 800 元，总共 1400 元，而不会出现用户 A 扣除了 200 元，但用户 B 未增加的情况（该情况，用户 A 和 B 均为 600 元，总共 1200 元）。
- I （Isolation）隔离性：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致，因为多个事务同时使用相同的数据时，不会相互干扰，每个事务都有一个完整的数据空间，对其他并发事务是隔离的。也就是说，消费者购买商品这个事务，是不影响其他消费者购买的。
- D （Durability）持久性：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

问题来了，一般第一次接触就会觉得 C一致性 的描述较难理解，其实是有原因的，事务ACID也是有一个顺序的。

                                    A ---
                                        |
                                    I --- ---- C
                                        |
                                    D ---

也就是说，必须先实现A、I、D才能真正保证C。

### 如何实现A、I、D

- 持久性： 通过 redo log （重做日志）来保证的
- 原子性： 通过 undo log（回滚日志） 来保证的
- 隔离性： 通过 MVCC（多版本并发控制） 或锁机制来保证的
- 一致性： 通过持久性+原子性+隔离性来保证

## 并行事务的三大问题

### 脏读

如果一个事务**读到**了另一个**未提交事务修改过的数据**，就意味着发生了**脏读**现象。

### 不可重复读

在一个事务内多次读取同一个数据，如果出现前后两次读到的数据不一样的情况，就意味着发生了**不可重复读**现象。

### 幻读

在一个事务内多次查询某个符合查询条件的**记录数量**，如果出现前后两次查询到的记录数量不一样的情况，就意味着发生了**幻读**现象。

### 按严重性排序

脏读 > 不可重复读 > 幻读

因为这些并行事务的存在，为了保证数据库的高效性，并行事务又不可缺少，所以一个很好的隔离方案就必须需要了

## 事务的隔离级别有哪些？

- 读未提交： 指一个事务还没提交时，它做的变更就能被其他事务看到
- 读提交： 指一个事务提交之后，它做的变更才能被其他事务看到
- 可重复读： 指一个事务执行过程中看到的数据，一直跟这个事务启动时看到的数据是一致的，MySQL InnoDB 引擎的默认隔离级别
- 串行化： 会对记录加上读写锁，在多个事务对这条记录进行读写操作时，如果发生了读写冲突的时候，后访问的事务必须等前一个事务执行完成，才能继续执行

按照隔离水平排序

读未提交 < 读提交 < 可重复读 < 串行化