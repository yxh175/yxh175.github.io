---
title: GOåº•å±‚ï¼šè–›å®šè°”çš„æŒ‡é’ˆ
date: 2023-10-28 16:18:21
cover: https://s2.loli.net/2023/10/28/WNqXGb82tSnl7yA.png
top_img: https://s2.loli.net/2023/10/09/Y2EknVqJy5fWgpr.png
categories: 
- GO
tags:
- åº•å±‚å‰–æ
- æŒ‡é’ˆ
---

## é—®é¢˜å‡ºç°

ä»Šå¤©åœ¨`Golang`äº¤æµç¾¤åˆ’æ°´ï¼Œçªç„¶çœ‹åˆ°ä¸€ä¸ªå“¥ä»¬æå‡ºäº†è¿™ä¹ˆä¸€ä¸ªé—®é¢˜

![å¥‡æ€ªçš„è¿”å›](https://s2.loli.net/2023/10/28/ZaoFyBdmIHufsl8.png)

å—¯ï¼Ÿè¿™åˆæ˜¯Goçš„ä»€ä¹ˆå‘ï¼Œè®©ä¿ºç…ä¸€ç…ï¼Œå…ˆç®€å•çš„å¤ç°ä¸€ä¸‹

```go
package main

import "fmt"

type A struct{}

func main() {
	a := &A{}
	b := &A{}
	c := &A{}

	fmt.Println(a == b, b == c)
	fmt.Println(a, b)
}

// true false
// &{} &{}
```

ä¸å¸¦`fmt.Println(a, b)`

```go
package main

import "fmt"

type A struct{}

func main() {
	a := &A{}
	b := &A{}
	c := &A{}

	fmt.Println(a == b, b == c)
	// fmt.Println(a, b)
}
// false false
```

å¥½å®¶ä¼™ï¼Œè¿™ç¬é—´è®©æˆ‘æƒ³åˆ°äº†è–›å®šè°”çš„çŒ«ã€‚ä¸è§‚æµ‹å®ƒï¼Œå®ƒçš„çŠ¶æ€æ˜¯æœªçŸ¥çš„ï¼Œè§‚æµ‹çš„ä¸€ç¬é—´çŠ¶æ€åç¼©åˆ°ä¸€ä¸ªç¡®å®šçš„å€¼ ğŸ‚ã€‚è¿˜å¥½è¿™ç§äº‹æƒ…æ˜¯åœ¨æˆ‘ä»¬ç¨‹åºå‘ç”Ÿï¼Œæƒ³è§‚æµ‹è¿™é‡Œçš„åŸå› è¿˜ä¸æ˜¯æ‰‹åˆ°æ“’æ¥ã€‚

## å‰–æ

å…¶å®çœ‹åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸€å®š`Go`åº•å±‚åŸºç¡€çš„è‚¯å®šä¸Šæ¥çŒœä¸ªå¤§æ¦‚ï¼Œè¿™è·Ÿå†…å­˜é€ƒé€¸è‚¯å®šæ²¡è·‘äº†ã€‚

### éªŒè¯æ€è·¯

çŒœæµ‹æ˜¯ç©ºç»“æ„ä½“çš„æŒ‡é’ˆåœ¨`GC`çš„ä¼˜åŒ–å¯¼è‡´çš„å¼‚å¸¸ã€‚è€Œè¿™æ­£æ˜¯å› ä¸ºæˆ‘ä»¬è°ƒç”¨Printlnè§‚æµ‹å¯¼è‡´çš„ã€‚æ—¢ç„¶ä¸èƒ½ç”¨fmtåŒ…å»çœ‹ï¼Œè¦è§‚æµ‹è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®è¿˜å¯ä»¥ç”¨é›ªè—çš„`println`å»è§£å†³, `println`æ˜¯`Go`åœ¨å®ç°è‡ªä¸¾çš„æ—¶å€™ä¾›å¼€å‘äººå‘˜æ‰“å°ä½¿ç”¨çš„ï¼Œåç»­å¹¶ä¸èƒ½ä¿è¯å…¶èƒ½æ­£å¸¸å·¥ä½œã€‚å¦‚æœæƒ³äº†è§£å’Œ`fmt`åŒ…çš„ä¸åŒï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ªçŸ¥ä¹é—®é¢˜[Golangä¸­fmt.Printlnå’Œç›´æ¥printlnæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ](https://www.zhihu.com/question/335186436)

æ‰€ä»¥æˆ‘ä»¬æ”¹ä¸€ä¸‹ä»£ç çœ‹çœ‹

```go
package main

import "fmt"

type A struct{}

func main() {
	a := &A{}
	b := &A{}
	c := &A{}
	d := &A{}

	println("a, bçš„åœ°å€ï¼š ", a, b)
	fmt.Println(b == a)
	fmt.Printf("c, d çš„åœ°å€ï¼š%p\t%p\t%t\n", c, d, c == d)
}
// a, bçš„åœ°å€ï¼š  0xc00007df2f 0xc00007df2f
// false
// c, d çš„åœ°å€ï¼š0x5d9540	0x5d9540	true
```

æ˜æ˜æ˜¯ä¸€èµ·åˆ›å»ºï¼Œä¸ºä»€ä¹ˆa,bçš„åœ°å€æ˜¯ä¸€ç±»ï¼Œä½†æ˜¯åˆæ˜¯`false`ï¼Œcã€dçš„åœ°å€åˆæ˜¯ä¸€ç±»ï¼Œä¸¤è€…åˆæ˜¯trueã€‚å¥‡æ€ªå¥‡æ€ªã€‚è¿™æ—¶å€™æˆ‘ä¸‹æ„è¯†çš„æƒ³åˆ°ã€‚æ—¢ç„¶åè€…çš„`fmt.Println()`ä¸­çš„è°ƒç”¨å¯¼è‡´äº†ï¼ŒæŒ‡é’ˆä¸åŒï¼Œæœ‰æ²¡æœ‰å¯èƒ½æ˜¯ç¼–è¯‘å™¨çš„é—®é¢˜ã€‚è€ƒè™‘åˆ°`fmt`ä¸­å¤§é‡çš„åå°„ç›¸å…³æ–¹æ³•çš„è°ƒç”¨ã€‚ç¼–è¯‘å™¨ä¼˜åŒ–çš„**é€ƒé€¸åˆ†æ**ï¼Œç„¶å`println`æ˜¯æ ˆä¸ŠæŒ‡é’ˆçš„æ¯”è¾ƒï¼Œ`fmt.Println`æ˜¯å †ä¸ŠæŒ‡é’ˆçš„æ¯”è¾ƒã€‚è¿™å¤šåŠæ²¡è·‘äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯éªŒè¯äº†ã€‚

### é€ƒé€¸åˆ†æ

å¦‚æœä¸ç†è§£é€ƒé€¸åˆ†ææ˜¯ä»€ä¹ˆï¼Œå¯ä»¥å…ˆçœ‹ä¸€ä¸‹è¿™ç¯‡æ–‡ç« [é€ƒé€¸åˆ†æ](https://geektutu.com/post/hpg-escape-analysis.html)ã€‚ç®€å•æ¥è®²ï¼Œç¼–è¯‘å™¨å†³å®šå†…å­˜åˆ†é…ä½ç½®çš„æ–¹å¼ï¼Œå°±ç§°ä¹‹ä¸ºé€ƒé€¸åˆ†æ(escape analysis)ã€‚é€ƒé€¸åˆ†æç”±ç¼–è¯‘å™¨å®Œæˆï¼Œä½œç”¨äºç¼–è¯‘é˜¶æ®µã€‚

æˆ‘ä»¬è¯•ç€ä½¿ç”¨goçš„é€ƒé€¸åˆ†ææŒ‡ä»¤å»è§‚æµ‹ä¸€ä¸‹ã€‚

```shell
go run -gcflags="-m -l" main.go
```

å¾—åˆ°è¿™æ ·çš„ç»“æœ

```text
# command-line-arguments
.\main.go:8:7: &A{} does not escape
.\main.go:9:7: &A{} does not escape
.\main.go:10:7: &A{} escapes to heap
.\main.go:11:7: &A{} escapes to heap
.\main.go:14:13: ... argument does not escape
.\main.go:14:16: b == a escapes to heap
.\main.go:15:12: ... argument does not escape
.\main.go:15:54: c == d escapes to heap
a, bçš„åœ°å€ï¼š  0xc000109f2f 0xc000109f2f
false
c, d çš„åœ°å€ï¼š0xe89560   0xe89560        true
```

å¯ä»¥çœ‹åˆ°8ã€9 ä¸¤è¡Œçš„åˆ›å»ºæ²¡æœ‰é€ƒé€¸ï¼Œ10ã€11åˆ™é€ƒé€¸åˆ°å †ä¸Šäº†ã€‚é‚£ä¹ˆä¸¤è€…å‡ºç°åŒºåˆ«çš„åŸå› çœ‹æ¥æ˜¯æ‰¾åˆ°äº†ã€‚é‚£ä¸ºä»€ä¹ˆä¸¤è€…çš„å€¼åˆä¸ç›¸åŒå‘¢ï¼Ÿ

### ä¸ºä»€ä¹ˆé€ƒé€¸åç›¸ç­‰

è¿™ä¸ªä¸»è¦å’Œ`go`çš„`gc`ä¼˜åŒ–æœ‰å…³ï¼Œå¯¹äºä¸€ä¸ªç©ºç»“æ„ä½“ï¼Œ`go`æ˜¯å¦‚ä½•ä¼˜åŒ–çš„å¤§å®¶å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« çš„è¯¦ç»†éƒ¨åˆ†[Go æœ€ç»†èŠ‚ç¯‡ â€” ç©ºç»“æ„ä½“æ˜¯ä»€ä¹ˆ?](https://juejin.cn/post/6908733156707287048)ã€‚æˆ‘ç®€å•å–å…¶ä¸­é‡è¦çš„éƒ¨åˆ†

![å†…å­˜ç®¡ç†ç‰¹æ®Šå¤„ç†](https://s2.loli.net/2023/10/28/2AjHfwv1xzSFhJK.png)

æ‰€ä»¥ç©º`struct`åœ¨é€ƒé€¸åæœ¬è´¨ä¸ŠæŒ‡å‘äº†`zerobase`ï¼Œå…¶ä¸¤è€…æ¯”è¾ƒå°±æ˜¯ç›¸ç­‰çš„ï¼Œè¿”å›äº†`true`ã€‚

### ä¸ºä»€ä¹ˆä¸é€ƒé€¸ä¸ç›¸ç­‰

è¿™é‡Œå…¶å®æˆ‘ä¹Ÿå¹¶ä¸ç†è§£ï¼Œå› ä¸ºæˆ‘ä»¬çœ‹åˆ°è¾“å‡ºï¼Œä¸¤ä¸ªaã€bä¸¤ä¸ªæŒ‡é’ˆå®é™…ä¸Šå€¼æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯ä»ç„¶æ˜¯`false`ã€‚è¿™å…¶ä¸­è‚¯å®šæœ‰å…¶ä»–åŸå› ã€‚æŸ¥çœ‹`golang`çš„[è¯­è¨€è§„èŒƒ](https://go.dev/ref/spec#Comparison_operators)ä¸­å¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€æ®µæè¿°

![goè¯­è¨€è§„èŒƒ](https://s2.loli.net/2023/10/28/u7XRlBqSGgNyoi8.png)

æ³¨æ„è¿™å¥è¯`Pointer types are comparable. Two pointer values are equal if they point to the same variable or if both have value . Pointers to distinct zero-size variables may or may not be equal. nil`

ä¹Ÿå°±æ˜¯è¯´åœ¨æ²¡é€ƒé€¸çš„åœºæ™¯ä¸‹ï¼Œä¸¤ä¸ªç©º`struct`çš„æ¯”è¾ƒåŠ¨ä½œï¼Œå¹¶ä¸æ˜¯çœŸçš„åœ¨æ¯”è¾ƒã€‚å®é™…ä¸Šå·²ç»åœ¨ä»£ç ä¼˜åŒ–é˜¶æ®µè¢«ç›´æ¥ä¼˜åŒ–æ‰ï¼Œè½¬ä¸ºäº†`false`ã€‚æ‰€ä»¥`a==b`ä¸¤è€…å®é™…æ²¡æœ‰è¿›è¡Œæ¯”è¾ƒï¼Œç›´æ¥è¿”å›çš„false
